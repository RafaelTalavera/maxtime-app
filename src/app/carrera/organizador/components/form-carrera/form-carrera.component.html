<form class="container-fluid mt-4" (ngSubmit)="onSubmit(carreraForm)" #carreraForm="ngForm">
  <div class="card card-custom">
    <div class="card-header">
      <h5 class="custom-h5">Crear la publicación de un evento</h5>
    </div>
    <div class="card-body">
      <!-- Primera fila de inputs -->
      <div class="row">
        <div class="col-md-5 form-group">
          <label class="custom-label" for="nombre">Nombre del evento</label>
          <input type="text" class="form-control my-2 custom-input" id="nombre" name="nombre" [(ngModel)]="carrera.nombre" #nombre="ngModel" required>
          <div *ngIf="nombre.invalid && (nombre.dirty || nombre.touched)" class="text alert-danger">
            <div *ngIf="nombre.errors?.['required']">El nombre del evento es requerido</div>
          </div>
        </div>
        <div class="col-md-2 form-group">
          <label class="custom-label" for="fecha">Fecha del evento</label>
          <input type="date" class="form-control my-2 custom-input" id="fecha" name="fecha" [(ngModel)]="carrera.fecha" #fecha="ngModel" required>
          <div *ngIf="fecha.invalid && (fecha.dirty || fecha.touched)" class="text alert-danger">
            <div *ngIf="fecha.errors?.['required']">La fecha es requerida</div>
          </div>
        </div>
        <div class="col-md-2 form-group">
          <label class="custom-label" for="fechaDeCierreDeInscripcion">Cierre inscripción</label>
          <input type="date" class="form-control my-2 custom-input" id="fechaDeCierreDeInscripcion" name="fechaDeCierreDeInscripcion" [(ngModel)]="carrera.fechaDeCierreDeInscripcion" #fechaDeCierreDeInscripcion="ngModel" required>
          <div *ngIf="fechaDeCierreDeInscripcion.invalid && (fechaDeCierreDeInscripcion.dirty || fechaDeCierreDeInscripcion.touched)" class="text alert-danger">
            <div *ngIf="fechaDeCierreDeInscripcion.errors?.['required']">La fecha de cierre es requerida</div>
          </div>
        </div>
        <div class="col-md-3 form-group">
          <label class="custom-label" for="localidad">Localidad</label>
          <input type="text" class="form-control my-2 custom-input" id="localidad" name="localidad" [(ngModel)]="carrera.localidad" #localidad="ngModel" required>
          <div *ngIf="localidad.invalid && (localidad.dirty || localidad.touched)" class="text alert-danger">
            <div *ngIf="localidad.errors?.['required']">La localidad es requerida</div>
          </div>
        </div>
      </div>

      <!-- Segunda fila de inputs -->
      <div class="row">
        <div class="col-md-3 form-group">
          <label class="custom-label" for="provincia">Provincia</label>
          <input type="text" class="form-control my-2 custom-input" id="provincia" name="provincia" [(ngModel)]="carrera.provincia" #provincia="ngModel" required>
          <div *ngIf="provincia.invalid && (provincia.dirty || provincia.touched)" class="text alert-danger">
            <div *ngIf="provincia.errors?.['required']">La provincia es requerida</div>
          </div>
        </div>
        <div class="col-md-3 form-group">
          <label class="custom-label" for="pais">País</label>
          <input type="text" class="form-control my-2 custom-input" id="pais" name="pais" [(ngModel)]="carrera.pais" #pais="ngModel" required>
          <div *ngIf="pais.invalid && (pais.dirty || pais.touched)" class="text alert-danger">
            <div *ngIf="pais.errors?.['required']">El país es requerido</div>
          </div>
        </div>
        <div class="col-md-4 form-group">
          <label class="custom-label" for="contacto">Contacto (Whatsapp)</label>
          <input type="text" class="form-control my-2 custom-input" id="contacto" name="contacto" [(ngModel)]="carrera.contacto" #contacto="ngModel" required>
          <div *ngIf="contacto.invalid && (contacto.dirty || contacto.touched)" class="text alert-danger">
            <div *ngIf="contacto.errors?.['required']">El contacto es requerido</div>
          </div>
        </div>
        <div class="col-md-2 form-group">
          <label class="custom-label" for="horario">Horario</label>
          <input type="time" class="form-control my-2 custom-input" id="horario" name="horario" [(ngModel)]="carrera.horario" #horario="ngModel" required>
          <div *ngIf="horario.invalid && (horario.dirty || horario.touched)" class="text alert-danger">
            <div *ngIf="horario.errors?.['required']">El horario es requerido</div>
          </div>
        </div>
      </div>

      <!-- Detalles -->
      <div class="row">
        <div class="col-md-12 form-group">
          <label class="custom-label" for="detalles">Detalles del evento</label>
          <textarea class="form-control my-2 custom-input" id="detalles" name="detalles" [(ngModel)]="carrera.detalles" #detalles="ngModel" required (input)="adjustTextArea($event)"></textarea>
          <div *ngIf="detalles.invalid && (detalles.dirty || detalles.touched)" class="text alert-danger">
            <div *ngIf="detalles.errors?.['required']">Los detalles son requeridos</div>
          </div>
        </div>
      </div>

      <!-- Estado e imágenes -->
      <div class="row">
        <div class="col-md-5 form-group d-flex align-items-center mb-4">
          <label class="custom-label me-2" for="estado">¿Publicar el evento?</label>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="estado" name="estado" [(ngModel)]="carrera.estado" #estado="ngModel">
            <label class="form-check-label ms-2" for="estado">
              {{ carrera.estado ? 'Publicado' : 'No publicado' }}
            </label>
          </div>
        </div>
        <div class="row">
          <!-- Imagen 1 -->
          <div class="col-md-6 form-group">
            <label class="custom-label" for="imagen1">Adjuntar Imagen 1</label>
            <input type="file" class="form-control my-2 custom-input" id="imagen1" name="imagen1" (change)="onFileSelected($event, 1)" accept="image/*">
            <small class="form-text text-muted">Selecciona la primera imagen del evento.</small>
            <div *ngIf="imagen1Error" class="text alert-danger">Solo se permite una imagen en este campo menor a 13 mb.</div>
          </div>
          <!-- Imagen 2 -->
          <div class="col-md-6 form-group">
            <label class="custom-label" for="imagen2">Adjuntar Imagen 2</label>
            <input type="file" class="form-control my-2 custom-input" id="imagen2" name="imagen2" (change)="onFileSelected($event, 2)" accept="image/*">
            <small class="form-text text-muted">Selecciona la segunda imagen del evento.</small>
            <div *ngIf="imagen2Error" class="text alert-danger">Solo se permite una imagen en este campo menor a 13 mb.</div>
          </div>
        </div>
      </div>

      <!-- Adjuntos -->
      <div class="row mb-4">
        <div class="col-md-12 form-group">
          <label class="custom-label" for="adjuntos">Adjuntar archivos</label>
          <input type="file" class="form-control my-2 custom-input" id="adjuntos" name="adjuntos" (change)="onAdjuntosSelected($event)" multiple>
          <small class="form-text text-muted">Selecciona uno o más archivos adjuntos.</small>
        </div>
      </div>

      <!-- Talles -->
      <div class="row mb-4">
        <div class="col-md-12 form-group">
          <label class="custom-label">Agregar talles de remeras</label>
          <div class="d-flex mb-2">
            <input type="text" class="form-control me-2" placeholder="Ej: S, M, L, XL" [(ngModel)]="nuevoTalle" name="nuevoTalle" #talleInput="ngModel">
            <button type="button" class="btn btn-success" (click)="agregarTalle()">Agregar</button>
          </div>
          <ul class="list-group">
            <li *ngFor="let talle of carrera.talles; let i = index" class="list-group-item d-flex justify-content-between align-items-center">
              <div *ngIf="editingTalleIndex === i">
                <input type="text" class="form-control" [(ngModel)]="editedTalleValue">
              </div>
              <div *ngIf="editingTalleIndex !== i">
                {{ talle }}
              </div>
              <div>
                <button *ngIf="editingTalleIndex !== i" type="button" class="btn btn-secondary btn-sm me-2" (click)="editarTalle(i)">Editar</button>
                <button *ngIf="editingTalleIndex !== i" type="button" class="btn btn-danger btn-sm" (click)="eliminarTalle(i)">Eliminar</button>
                <button *ngIf="editingTalleIndex === i" type="button" class="btn btn-primary btn-sm me-2" (click)="guardarTalle(i)">Guardar</button>
                <button *ngIf="editingTalleIndex === i" type="button" class="btn btn-warning btn-sm" (click)="cancelarEdicionTalle()">Cancelar</button>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- Categorías -->
      <div class="row mb-4">
        <div class="col-md-12 form-group">
          <label class="custom-label">Agregar categoría</label>
          <div class="d-flex mb-2">
            <input type="text" class="form-control me-2" placeholder="Nombre del campo (ej: Género)" [(ngModel)]="nuevoCampoNombre" name="nuevoCampoNombre">
            <input type="text" class="form-control me-2" placeholder="Valor (ej: Masculino)" [(ngModel)]="nuevoCampoValor" name="nuevoCampoValor">
            <div class="form-check form-switch align-self-center me-2">
              <input class="form-check-input" type="checkbox" [(ngModel)]="nuevoCampoActivo" name="nuevoCampoActivo" id="activoSwitch">
              <label class="form-check-label" for="activoSwitch">Activo</label>
            </div>
            <button type="button" class="btn btn-primary" (click)="agregarCategoria()">Agregar Categoría</button>
          </div>
        </div>
      </div>

      <!-- Lista de categorías agregadas -->
      <div class="row mb-4" *ngIf="carrera.categorias && carrera.categorias.length > 0">
        <div class="col-md-12 form-group">
          <label class="custom-label">Categorías agregadas</label>
          <ul class="list-group">
            <li *ngFor="let categoria of carrera.categorias; let i = index" class="list-group-item d-flex justify-content-between align-items-center">
              <div *ngIf="editingCategoriaIndex === i && editedCategoriaCampo as ec">
                <div *ngFor="let campo of categoria.campos">
                  <input type="text" class="form-control mb-1" placeholder="Nombre" [(ngModel)]="ec.nombre" [ngModelOptions]="{standalone: true}">
                  <input type="text" class="form-control mb-1" placeholder="Valor" [(ngModel)]="ec.valor" [ngModelOptions]="{standalone: true}">
                  <div class="form-check form-switch mb-1">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="ec.activo" [ngModelOptions]="{standalone: true}">
                    <label class="form-check-label">Activo</label>
                  </div>
                </div>
                <button type="button" class="btn btn-primary btn-sm me-2" (click)="guardarCategoria(i)">Guardar</button>
                <button type="button" class="btn btn-warning btn-sm" (click)="cancelarEdicionCategoria()">Cancelar</button>
              </div>
              <div *ngIf="editingCategoriaIndex !== i">
                <div *ngFor="let campo of categoria.campos">
                  {{ campo.nombre }}: {{ campo.valor }} <span *ngIf="campo.activo">(Activo)</span><span *ngIf="!campo.activo">(Inactivo)</span>
                </div>
                <button type="button" class="btn btn-secondary btn-sm me-2" (click)="editarCategoria(i)">Editar</button>
                <button type="button" class="btn btn-danger btn-sm" (click)="eliminarCategoria(i)">Eliminar</button>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- Botones de enviar y limpiar -->
      <div class="text-center">
        <button [disabled]="!carreraForm.form.valid" type="submit" class="btn btn-primary my-2 mx-3">
          {{ (carrera.id ?? 0) > 0 ? 'Editar' : 'Crear' }}
        </button>
        <button type="button" class="btn btn-success my-2 mx-3" (click)="clean()">Limpiar</button>
      </div>
    </div>
  </div>
</form>
